--- php-5.2.7/main/php_ini.c.org	2008-12-05 23:30:07.843241117 +0100
+++ php-5.2.7/main/php_ini.c	2008-12-05 23:36:18.096968965 +0100
@@ -475,21 +475,32 @@
 			}
 		}
 
-		/* Otherwise search for php-%sapi-module-name%.ini file in search path */
+		/* Search (global) php.ini file in search path */
 		if (!fh.handle.fp) {
-			const char *fmt = "php-%s.ini";
-			char *ini_fname;
-			spprintf(&ini_fname, 0, fmt, sapi_module.name);
-			fh.handle.fp = php_fopen_with_path(ini_fname, "r", php_ini_search_path, &php_ini_opened_path TSRMLS_CC);
-			efree(ini_fname);
+			fh.handle.fp = php_fopen_with_path("php.ini", "r", php_ini_search_path, &php_ini_opened_path TSRMLS_CC);
 			if (fh.handle.fp) {
 				fh.filename = php_ini_opened_path;
+				PG(safe_mode) = safe_mode_state;
+				PG(open_basedir) = open_basedir;
+				fh.type = ZEND_HANDLE_FP;
+				zend_parse_ini_file(&fh, 1, php_config_ini_parser_cb, &extension_lists);
+				safe_mode_state = PG(safe_mode);
+				open_basedir = PG(open_basedir);
+				PG(safe_mode) = 0;
+				PG(open_basedir) = NULL;
+				fh.handle.fp = NULL;
+				efree(php_ini_opened_path);
+				fh.filename = php_ini_opened_path = NULL;
 			}
 		}
 
-		/* If still no ini file found, search for php.ini file in search path */
+		/* Otherwise search for php-%sapi-module-name%.ini file in search path */
 		if (!fh.handle.fp) {
-			fh.handle.fp = php_fopen_with_path("php.ini", "r", php_ini_search_path, &php_ini_opened_path TSRMLS_CC);
+			const char *fmt = "php-%s.ini";
+			char *ini_fname;
+			spprintf(&ini_fname, 0, fmt, sapi_module.name);
+			fh.handle.fp = php_fopen_with_path(ini_fname, "r", php_ini_search_path, &php_ini_opened_path TSRMLS_CC);
+			efree(ini_fname);
 			if (fh.handle.fp) {
 				fh.filename = php_ini_opened_path;
 			}
@@ -533,9 +544,13 @@
 	/* Scan and parse any .ini files found in scan path if path not empty. */
 	if (!sapi_module.php_ini_ignore && php_ini_scanned_path_len) {
 		struct dirent **namelist;
-		int ndir, i;
+		int ndir, i, found = 0;
+		const char *fmt = PHP_CONFIG_FILE_PATH "/%s.d";
+		char *sapi_scan_dir = emalloc(strlen(fmt) + strlen(sapi_module.name));
+		sprintf(sapi_scan_dir, fmt, sapi_module.name);
 
 		if ((ndir = php_scandir(php_ini_scanned_path, &namelist, 0, php_alphasort)) > 0) {
+			found += ndir;
 			for (i = 0; i < ndir; i++) {
 				/* check for a .ini extension */
 				if (!(p = strrchr(namelist[i]->d_name, '.')) || (p && strcmp(p, ".ini"))) {
@@ -564,6 +579,38 @@
 				free(namelist[i]);
 			}
 			free(namelist);
+		}
+		
+		if ((ndir = php_scandir(sapi_scan_dir, &namelist, 0, php_alphasort)) > 0) {
+			found += ndir;
+			for (i = 0; i < ndir; i++) {
+				/* check for a .ini extension */
+				if (!(p = strrchr(namelist[i]->d_name, '.')) || (p && strcmp(p, ".ini"))) {
+					free(namelist[i]);
+					continue;
+				}
+				snprintf(ini_file, MAXPATHLEN, "%s%c%s", sapi_scan_dir, DEFAULT_SLASH, namelist[i]->d_name);
+				if (VCWD_STAT(ini_file, &sb) == 0) {
+					if (S_ISREG(sb.st_mode)) {
+						if ((fh.handle.fp = VCWD_FOPEN(ini_file, "r"))) {
+							fh.filename = ini_file;
+							fh.type = ZEND_HANDLE_FP;
+							zend_parse_ini_file(&fh, 1, php_config_ini_parser_cb, &extension_lists);
+							/* Here, add it to the list of ini files read */
+							l = strlen(ini_file);
+							total_l += l + 2;
+							p = estrndup(ini_file, l);
+							zend_llist_add_element(&scanned_ini_list, &p);
+						}
+					}
+				}
+				free(namelist[i]);
+			}
+			free(namelist);
+		}
+		efree(sapi_scan_dir);
+
+		if (found) {
 
 			/*
 			 * Don't need an extra byte for the \0 in this malloc as the last
