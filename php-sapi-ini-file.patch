--- php-5.3.0/main/php_ini.c.org	2009-07-06 17:32:30.309904482 +0200
+++ php-5.3.0/main/php_ini.c	2009-07-06 17:36:45.529879052 +0200
@@ -474,6 +480,24 @@
 				}
 			}
 		}
+		/* Search (global) php.ini file in search path */
+		if (!fh.handle.fp) {
+			fh.handle.fp = php_fopen_with_path("php.ini", "r", php_ini_search_path, &php_ini_opened_path TSRMLS_CC);
+			if (fh.handle.fp) {
+				fh.filename = php_ini_opened_path;
+				PG(safe_mode) = safe_mode_state;
+				PG(open_basedir) = open_basedir;
+				fh.type = ZEND_HANDLE_FP;
+				zend_parse_ini_file(&fh, 1, ZEND_INI_SCANNER_NORMAL, (zend_ini_parser_cb_t) php_ini_parser_cb, &configuration_hash TSRMLS_CC);
+				safe_mode_state = PG(safe_mode);
+				open_basedir = PG(open_basedir);
+				PG(safe_mode) = 0;
+				PG(open_basedir) = NULL;
+				fh.handle.fp = NULL;
+				efree(php_ini_opened_path);
+				fh.filename = php_ini_opened_path = NULL;
+			}
+		}
 
 		/* Otherwise search for php-%sapi-module-name%.ini file in search path */
 		if (!fh.handle.fp) {
@@ -486,14 +510,6 @@
 				fh.filename = php_ini_opened_path;
 			}
 		}
-
-		/* If still no ini file found, search for php.ini file in search path */
-		if (!fh.handle.fp) {
-			fh.handle.fp = php_fopen_with_path("php.ini", "r", php_ini_search_path, &php_ini_opened_path TSRMLS_CC);
-			if (fh.handle.fp) {
-				fh.filename = php_ini_opened_path;
-			}
-		}
 	}
 
 	if (free_ini_search_path) {
@@ -620,12 +620,14 @@
 		zend_llist scanned_ini_list;
 		zend_llist_element *element;
 		int l, total_l = 0;
+		const char *fmt = "%s:" PHP_CONFIG_FILE_PATH "/%s.d";
 
 		/* List of found ini files */
 		zend_llist_init(&scanned_ini_list, sizeof(char *), (llist_dtor_func_t) free_estring, 1);
 		
 		/* Split by paths_separator and load ini-files from all paths */
-		path_copy = estrdup(php_ini_scanned_path);
+		path_copy = emalloc(strlen(php_ini_scanned_path) + strlen(fmt) + strlen(sapi_module.name));
+		sprintf(path_copy, fmt, php_ini_scanned_path, sapi_module.name);
 		ini_path  = php_strtok_r(path_copy, paths_separator, &last);
 
 		while (ini_path != NULL) {
